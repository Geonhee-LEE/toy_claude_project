# ============================================================
# nav2 파라미터 - Swerve Drive Spline-MPPI
# ============================================================
# 사용법:
#   ros2 launch mpc_controller_ros2 mppi_ros2_control_nav2.launch.py controller:=swerve
#
# Swerve Drive 로봇 (홀로노믹, vx/vy/omega 3축 제어)
# Spline-MPPI: B-spline basis로 P개 knot → N개 보간 (C² 연속 보장)
# ============================================================

controller_server:
  ros__parameters:
    use_sim_time: true
    controller_frequency: 10.0
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.001
    min_theta_velocity_threshold: 0.001
    failure_tolerance: 0.5
    transform_tolerance: 1.0
    progress_checker_plugins: ["progress_checker"]
    goal_checker_plugins: ["goal_checker"]
    controller_plugins: ["FollowPath"]

    # Progress checker
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.3
      movement_time_allowance: 30.0

    # Goal checker
    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25
      yaw_goal_tolerance: 0.4
      stateful: true

    # ---- Swerve Drive Spline-MPPI Controller ----
    FollowPath:
      plugin: "mpc_controller_ros2::SplineMPPIControllerPlugin"
      motion_model: "swerve"

      # Prediction horizon
      N: 30
      dt: 0.1

      # Sampling
      K: 1024
      lambda: 10.0

      # Noise parameters (vx, vy, omega)
      noise_sigma_v: 0.5
      noise_sigma_vy: 0.2
      noise_sigma_omega: 0.2

      # Control limits (diff_drive 파라미터 유지 — swerve는 내부적으로 vx/vy/omega 사용)
      v_max: 1.5
      v_min: -0.1   # 후진 거의 차단 (-0.5 → -0.1)
      omega_max: 2.0
      omega_min: -2.0

      # State tracking cost weights (Q: x, y, theta)
      Q_x: 10.0
      Q_y: 10.0
      Q_theta: 3.0

      # Terminal cost weights (Qf)
      Qf_x: 20.0
      Qf_y: 20.0
      Qf_theta: 6.0

      # Control effort weights (R: vx, vy, omega)
      R_v: 0.3
      R_vy: 1.0
      R_omega: 0.8

      # Control rate weights (R_rate: vx, vy, omega)
      R_rate_v: 0.5
      R_rate_vy: 0.5
      R_rate_omega: 1.0

      # Obstacle avoidance
      obstacle_weight: 300.0
      safety_distance: 0.5

      # Costmap obstacle cost
      use_costmap_cost: true
      costmap_lethal_cost: 5000.0
      costmap_critical_cost: 500.0
      lookahead_dist: 1.5   # 고정 lookahead (0=auto=v_max*N*dt=4.5, 너무 긺)
      min_lookahead: 0.5
      goal_slowdown_dist: 0.5

      # Forward preference (Spline-MPPI는 구조적 평활성으로 후진 억제 효과)
      prefer_forward_weight: 10.0   # 후진 페널티 강화 (5.0 → 10.0)
      prefer_forward_linear_ratio: 0.5
      prefer_forward_velocity_incentive: 2.0  # 전진 인센티브 (vx>0 보상)

      # Control smoothing (EMA 출력 필터 — SG 필터 활성 시 무시됨)
      control_smoothing_alpha: 0.7  # EMA 완화 (0.5 → 0.7, 응답성 개선)

      # Trajectory Stability
      sg_filter_enabled: true       # SG 필터 ON (EMA 대체)
      sg_half_window: 3             # 과거3 + 현재 + 미래3 = 7점 윈도우
      sg_poly_order: 3              # 3차 다항식
      it_alpha: 0.975               # IT 정규화 ON (보수적)
      exploration_ratio: 0.1        # 10% 탐색 샘플

      # Adaptive Temperature
      adaptive_temperature: true
      target_ess_ratio: 0.2   # 가중치 집중도 증가 (0.5→0.2, 상위 20% 샘플에 집중)
      adaptation_rate: 0.1
      lambda_min: 0.1
      lambda_max: 100.0

      # Spline-MPPI 전용 파라미터
      spline_num_knots: 12              # B-spline 제어점 수 (P << N, 12 knots → 30 steps)
      spline_degree: 3                  # B-spline 차수 (cubic → C² 연속)
      spline_auto_knot_sigma: true      # basis 감쇠 자동 보정

      # SOTA 변형 (기본값)
      tsallis_q: 1.5
      cvar_alpha: 0.5
      svgd_num_iterations: 0
      svgd_step_size: 0.1
      svgd_bandwidth: -1.0
      smooth_R_jerk_v: 0.1
      smooth_R_jerk_omega: 0.1
      smooth_action_cost_weight: 1.0    # Spline-MPPI: smooth cost 활성화
      svg_num_guide_particles: 10
      svg_guide_iterations: 3
      svg_guide_step_size: 0.1
      svg_resample_std: 0.3

      # Non-Coaxial 전용 (swerve에서는 무시 — declare 필수)
      noise_sigma_delta_dot: 0.3
      R_delta_dot: 0.5
      R_rate_delta_dot: 1.0
      max_steering_rate: 2.0
      max_steering_angle: 1.5707

      # CBF (Control Barrier Function) 안전성 보장
      cbf_enabled: false
      cbf_gamma: 1.0
      cbf_safety_margin: 0.3
      cbf_robot_radius: 0.2
      cbf_activation_distance: 3.0
      cbf_cost_weight: 500.0
      cbf_use_safety_filter: true

      # Collision Debug (기본 OFF, ros2 param set으로 실시간 활성화)
      debug_collision_viz: false
      debug_cost_breakdown: true
      debug_collision_points: true
      debug_safety_footprint: true
      debug_cost_heatmap: true
      debug_footprint_radius: 0.3
      debug_heatmap_stride: 3

      # Visualization
      visualize_samples: true
      visualize_best: true
      visualize_weighted_avg: true
      visualize_reference: true
      visualize_text_info: true
      visualize_control_sequence: true
      visualize_tube: false
      max_visualized_samples: 20
