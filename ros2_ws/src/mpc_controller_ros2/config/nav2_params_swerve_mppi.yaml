# ============================================================
# nav2 파라미터 - Swerve Drive MPPI
# ============================================================
# 사용법:
#   ros2 launch mpc_controller_ros2 mppi_ros2_control_nav2.launch.py controller:=swerve
#
# Swerve Drive 로봇 (홀로노믹, vx/vy/omega 3축 제어)
# ============================================================

controller_server:
  ros__parameters:
    use_sim_time: true
    controller_frequency: 10.0
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.001
    min_theta_velocity_threshold: 0.001
    failure_tolerance: 0.5
    transform_tolerance: 1.0
    progress_checker_plugins: ["progress_checker"]
    goal_checker_plugins: ["goal_checker"]
    controller_plugins: ["FollowPath"]

    # Progress checker
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.3
      movement_time_allowance: 30.0

    # Goal checker
    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25
      yaw_goal_tolerance: 0.25
      stateful: true

    # ---- Swerve Drive MPPI Controller ----
    FollowPath:
      plugin: "mpc_controller_ros2::MPPIControllerPlugin"
      motion_model: "swerve"

      # Prediction horizon
      N: 30
      dt: 0.1

      # Sampling
      K: 1024
      lambda: 10.0

      # Noise parameters (vx, vy, omega → sigma_v covers vx)
      noise_sigma_v: 0.5
      noise_sigma_omega: 0.3

      # Control limits (diff_drive 파라미터 유지 — swerve는 내부적으로 vx/vy/omega 사용)
      v_max: 1.5
      v_min: -1.5
      omega_max: 2.0
      omega_min: -2.0

      # State tracking cost weights (Q: x, y, theta)
      Q_x: 10.0
      Q_y: 10.0
      Q_theta: 1.0

      # Terminal cost weights (Qf)
      Qf_x: 20.0
      Qf_y: 20.0
      Qf_theta: 2.0

      # Control effort weights (R: v, omega — swerve에서는 vx, omega)
      R_v: 0.3
      R_omega: 0.3

      # Control rate weights (R_rate)
      R_rate_v: 0.5
      R_rate_omega: 0.5

      # Obstacle avoidance
      obstacle_weight: 100.0
      safety_distance: 0.5

      # Costmap obstacle cost
      use_costmap_cost: true
      costmap_lethal_cost: 500.0
      costmap_critical_cost: 50.0
      lookahead_dist: 0.0
      min_lookahead: 0.5
      goal_slowdown_dist: 1.0

      # Forward preference (swerve는 홀로노믹이므로 낮은 가중치)
      prefer_forward_weight: 1.0
      prefer_forward_linear_ratio: 0.3

      # Adaptive Temperature
      adaptive_temperature: true
      target_ess_ratio: 0.5
      adaptation_rate: 0.1
      lambda_min: 0.1
      lambda_max: 100.0

      # SOTA 변형 (기본값)
      tsallis_q: 1.5
      cvar_alpha: 0.5
      svgd_num_iterations: 0
      svgd_step_size: 0.1
      svgd_bandwidth: -1.0
      smooth_R_jerk_v: 0.1
      smooth_R_jerk_omega: 0.1
      smooth_action_cost_weight: 0.0
      spline_num_knots: 8
      spline_degree: 3
      svg_num_guide_particles: 10
      svg_guide_iterations: 3
      svg_guide_step_size: 0.1
      svg_resample_std: 0.3

      # Visualization
      visualize_samples: true
      visualize_best: true
      visualize_weighted_avg: true
      visualize_reference: true
      visualize_text_info: true
      visualize_control_sequence: true
      visualize_tube: false
      max_visualized_samples: 20
