# ============================================================
# nav2 파라미터 - nav2 기본 MPPI Controller
# ============================================================
# 사용법:
#   ros2 launch mpc_controller_ros2 mppi_ros2_control_nav2.launch.py controller:=nav2
#
# 이 파일은 controller_server 전용 파라미터입니다.
# 공통 파라미터(AMCL, costmap, planner 등)는 nav2_params.yaml에 있습니다.
#
# 커스텀 MPPI와 동일한 조건에서 비교할 수 있도록
# 제어 제한, horizon 등을 최대한 맞춤.
# ============================================================

controller_server:
  ros__parameters:
    use_sim_time: true
    controller_frequency: 10.0
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.001
    min_theta_velocity_threshold: 0.001
    failure_tolerance: 0.5
    progress_checker_plugins: ["progress_checker"]
    goal_checker_plugins: ["goal_checker"]
    controller_plugins: ["FollowPath"]

    # Progress checker
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.3
      movement_time_allowance: 30.0

    # Goal checker
    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25
      yaw_goal_tolerance: 0.25
      stateful: true

    # ---- nav2 기본 MPPI Controller ----
    FollowPath:
      plugin: "nav2_mppi_controller::MPPIController"

      # Prediction horizon (커스텀과 동일: N=30, dt=0.1)
      time_steps: 30
      model_dt: 0.1

      # Sampling (커스텀과 동일: K=1024)
      batch_size: 1024

      # Temperature (커스텀 lambda=10.0에 대응)
      gamma: 0.015

      # Control limits (커스텀과 동일)
      vx_max: 0.5
      vx_min: -0.2
      vy_max: 0.0
      wz_max: 1.0

      # Noise (커스텀 sigma와 대응)
      iteration_count: 1
      temperature: 300
      retry_attempt_limit: 1

      # Motion model (커스텀은 DifferentialDrive)
      motion_model: "DiffDrive"

      # Trajectory visualization
      visualize: true
      trajectory_visualizer:
        trajectory_step: 5
        time_step: 3

      # Transform tolerance
      transform_tolerance: 0.1

      # Enforce path inversion (differential drive에서 후진 허용)
      enforce_path_inversion: false

      # ---- Critics (비용 함수) ----
      # 커스텀의 5가지 비용 함수에 대응하는 Critics 구성
      critics:
        - "GoalCritic"
        - "GoalAngleCritic"
        - "PathFollowCritic"
        - "PathAlignCritic"
        - "PathAngleCritic"
        - "PreferForwardCritic"
        - "ObstaclesCritic"
        - "TwirlingCritic"

      # GoalCritic: 커스텀의 TerminalCost에 대응
      GoalCritic:
        enabled: true
        cost_power: 1
        cost_weight: 5.0
        threshold_to_consider: 1.4

      # GoalAngleCritic: 커스텀의 Q_theta (Terminal)에 대응
      GoalAngleCritic:
        enabled: true
        cost_power: 1
        cost_weight: 3.0
        threshold_to_consider: 0.5

      # PathFollowCritic: 커스텀의 StateTrackingCost (Q_x, Q_y)에 대응
      PathFollowCritic:
        enabled: true
        cost_power: 1
        cost_weight: 5.0
        offset_from_furthest: 5
        threshold_to_consider: 1.4

      # PathAlignCritic: 경로 정렬
      PathAlignCritic:
        enabled: true
        cost_power: 1
        cost_weight: 14.0
        max_path_occupancy_ratio: 0.05
        trajectory_point_step: 4
        threshold_to_consider: 0.5
        use_path_orientations: false

      # PathAngleCritic: 경로 방향 추종
      PathAngleCritic:
        enabled: true
        cost_power: 1
        cost_weight: 2.0
        offset_from_furthest: 4
        threshold_to_consider: 0.5
        max_angle_to_furthest: 1.0
        mode: 0

      # PreferForwardCritic: 전진 선호
      PreferForwardCritic:
        enabled: true
        cost_power: 1
        cost_weight: 5.0
        threshold_to_consider: 0.5

      # ObstaclesCritic: 커스텀의 ObstacleCost에 대응
      ObstaclesCritic:
        enabled: true
        cost_power: 1
        cost_weight: 10.0
        repulsion_weight: 0.1
        critical_weight: 20.0
        consider_footprint: false
        collision_cost: 10000.0
        collision_margin_distance: 0.1
        near_goal_distance: 0.5

      # TwirlingCritic: 불필요한 회전 억제 (ControlEffortCost 유사)
      TwirlingCritic:
        enabled: true
        twirling_cost_power: 1
        twirling_cost_weight: 10.0
