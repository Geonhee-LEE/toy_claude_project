# Claude Code GitHub Action (OAuth Token ì‚¬ìš©)
# êµ¬ë…ììš© (Max/Pro Plan)
#
# ì„¤ì • ë°©ë²•:
# 1. https://console.anthropic.com ì—ì„œ OAuth í† í° ìƒì„±
# 2. GitHub Repo > Settings > Secrets and variables > Actions
# 3. "CLAUDE_CODE_OAUTH_TOKEN" ì‹œí¬ë¦¿ ì¶”ê°€
#
# ì‚¬ìš©ë²•:
# - ì´ìŠˆì— @claude ë©˜ì…˜í•˜ì—¬ ì½”ë“œ ì‘ì„± ìš”ì²­
# - PRì— @claude ë©˜ì…˜í•˜ì—¬ ì½”ë“œ ë¦¬ë·° ìš”ì²­
# - ë¼ë²¨ "claude" ì¶”ê°€í•˜ì—¬ ìë™ ë¶„ì„

name: Claude Code

on:
  # ì´ìŠˆ ì´ë²¤íŠ¸
  issues:
    types: [opened, labeled]

  # ì´ìŠˆ ëŒ“ê¸€ (@claude ë©˜ì…˜)
  issue_comment:
    types: [created]

  # PR ì´ë²¤íŠ¸
  pull_request:
    types: [opened, synchronize, reopened]

  # PR ë¦¬ë·° ëŒ“ê¸€
  pull_request_review_comment:
    types: [created]

jobs:
  claude-code:
    # ì¡°ê±´: @claude ë©˜ì…˜ ë˜ëŠ” claude ë¼ë²¨
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude')) ||
      (github.event_name == 'pull_request')

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        uses: anthropics/claude-code-action@beta
        with:
          # OAuth í† í° (êµ¬ë…ììš©)
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # ëª¨ë¸ ì„¤ì • (ì„ íƒì‚¬í•­)
          model: "claude-sonnet-4-20250514"

          # ìµœëŒ€ í† í° (ì„ íƒì‚¬í•­)
          max_tokens: 16000

          # íƒ€ì„ì•„ì›ƒ (ë¶„)
          timeout_minutes: 10

          # ìë™ ì»¤ë°‹ (PR ìƒì„± ì‹œ)
          auto_commit: true

          # í•œêµ­ì–´ ì‘ë‹µ
          custom_instructions: |
            - í•œêµ­ì–´ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”
            - ì½”ë“œ ë³€ê²½ ì‹œ RVIZ ë§ˆì»¤ ì‹œê°í™”ë¥¼ ê³ ë ¤í•´ì£¼ì„¸ìš”
            - Conventional Commits í˜•ì‹ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”
            - ë¡œë´‡ MPC ì œì–´ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤

      - name: Comment on issue/PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;

            if (eventName === 'issue_comment' || eventName === 'issues') {
              // ì´ìŠˆì— ë°˜ì‘ ì¶”ê°€
              await github.rest.reactions.createForIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                content: 'eyes'
              });
            }

  # PR ìë™ ì½”ë“œ ë¦¬ë·°
  claude-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: "claude-sonnet-4-20250514"

          # ë¦¬ë·° ëª¨ë“œ
          mode: "review"

          custom_instructions: |
            ## ì½”ë“œ ë¦¬ë·° ê°€ì´ë“œë¼ì¸

            í•œêµ­ì–´ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”. ë‹¤ìŒ í•­ëª©ì„ ê²€í† í•´ì£¼ì„¸ìš”:

            ### ê²€í†  í•­ëª©
            1. ì½”ë“œ í’ˆì§ˆ ë° ê°€ë…ì„±
            2. ë²„ê·¸ ê°€ëŠ¥ì„±
            3. ì„±ëŠ¥ ë¬¸ì œ
            4. ë³´ì•ˆ ì·¨ì•½ì 
            5. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

            ### ì¶œë ¥ í˜•ì‹
            ## ì½”ë“œ ë¦¬ë·° ìš”ì•½
            [ì „ì²´ í‰ê°€]

            ## ì¢‹ì€ ì  âœ…
            - [ê¸ì •ì ì¸ ë¶€ë¶„]

            ## ê°œì„  ì œì•ˆ ğŸ’¡
            - [ê°œì„  ì‚¬í•­]

            ## ì ì¬ì  ì´ìŠˆ âš ï¸
            - [ì£¼ì˜ í•„ìš” ì‚¬í•­]

  # ì´ìŠˆì—ì„œ PR ìë™ ìƒì„±
  claude-implement:
    if: |
      github.event_name == 'issues' &&
      (contains(github.event.issue.labels.*.name, 'claude-autofix') ||
       contains(github.event.issue.labels.*.name, 'claude-implement'))

    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Implement Feature
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: "claude-sonnet-4-20250514"
          max_tokens: 32000
          timeout_minutes: 15

          # êµ¬í˜„ ëª¨ë“œ
          mode: "implement"

          # ìë™ìœ¼ë¡œ ë¸Œëœì¹˜ ìƒì„± ë° PR ìƒì„±
          auto_commit: true
          create_pr: true

          # ì´ìŠˆ ì •ë³´ ì „ë‹¬
          issue_number: ${{ github.event.issue.number }}

          custom_instructions: |
            ## êµ¬í˜„ ê°€ì´ë“œë¼ì¸

            ì´ í”„ë¡œì íŠ¸ëŠ” ë¡œë´‡ MPC ì‹œë®¬ë ˆì´ì…˜ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

            ### ì½”ë“œ ìŠ¤íƒ€ì¼
            - Python íƒ€ì… íŒíŠ¸ ì‚¬ìš©
            - Black í¬ë§·í„° ì¤€ìˆ˜
            - í•œêµ­ì–´ ì£¼ì„/ë…ìŠ¤íŠ¸ë§ ê°€ëŠ¥

            ### ë¸Œëœì¹˜ ëª…ëª…
            - feature/ê¸°ëŠ¥ëª…
            - fix/ë²„ê·¸ëª…

            ### ì»¤ë°‹ ë©”ì‹œì§€
            - feat: ìƒˆ ê¸°ëŠ¥
            - fix: ë²„ê·¸ ìˆ˜ì •
            - docs: ë¬¸ì„œ
            - refactor: ë¦¬íŒ©í† ë§

            ### í•„ìˆ˜ ì‚¬í•­
            - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¶”ê°€
            - RVIZ ë§ˆì»¤ ì‹œê°í™” ê³ ë ¤

      - name: Comment implementation status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';
            const message = status === 'success'
              ? `${emoji} Claudeê°€ êµ¬í˜„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. PRì„ í™•ì¸í•´ì£¼ì„¸ìš”.`
              : `${emoji} Claude êµ¬í˜„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
